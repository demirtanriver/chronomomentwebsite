{# your_app_name/templates/your_app_name/story_slideshow.html #}
{% extends 'main/base.html' %}
{% load static %}

{% block content %}
{# This outermost div now simply fills the space provided by base.html's 'main-content' and applies the background. #}
{# It does NOT have min-h-screen or centering flex properties here. #}
<div class="relative w-full h-full flex-grow bg-gradient-to-br from-indigo-500 to-purple-600 overflow-hidden">
    {# Background overlay for a subtle visual effect #}
    <div class="absolute inset-0 bg-black opacity-20 z-0"></div>

    {# NEW: This intermediate div is responsible for centering the actual slideshow container. #}
    {# It takes full width/height of its parent (the gradient div) and uses flex to center its child. #}
    <div class="w-full h-full flex items-center justify-center p-4 sm:p-6 md:p-8">

        {# The core slideshow container. This is the "card" that holds the slides. #}
        {# Its z-index is set to z-20 to be above the background overlay. #}
        <div id="slideshow-container" class="relative w-full max-w-4xl lg:max-w-5xl xl:max-w-6xl min-h-[70vh] max-h-[90vh] bg-white rounded-3xl shadow-2xl flex flex-col items-center justify-center text-center z-20 overflow-hidden transition-all duration-300 ease-in-out transform hover:scale-[1.005]">
            
            {# Navigation Arrows - positioned absolutely on the sides of the slideshow container #}
            {# Previous Button #}
            {# Z-index is z-30 to ensure it's on top of the slideshow container #}
            <button id="prev-btn" class="absolute left-4 sm:left-6 top-1/2 -translate-y-1/2 bg-white bg-opacity-40 hover:bg-opacity-60 text-gray-800 p-3 sm:p-4 rounded-full shadow-lg transition-all duration-300 z-30 focus:outline-none focus:ring-2 focus:ring-purple-400 focus:ring-opacity-75 active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 sm:h-8 sm:w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"> {# Increased stroke-width #}
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            {# Next Button #}
            {# Z-index is z-30 to ensure it's on top of the slideshow container #}
            <button id="next-btn" class="absolute right-4 sm:right-6 top-1/2 -translate-y-1/2 bg-white bg-opacity-40 hover:bg-opacity-60 text-gray-800 p-3 sm:p-4 rounded-full shadow-lg transition-all duration-300 z-30 focus:outline-none focus:ring-2 focus:ring-purple-400 focus:ring-opacity-75 active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 sm:h-8 sm:w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"> {# Increased stroke-width #}
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                </svg>
            </button>

            {# Slide content area - This div will hold the dynamic content of each slide #}
            {# Flex properties ensure content is centered vertically within this area #}
            <div id="slide-content" class="flex-grow flex flex-col items-center justify-center w-full h-full transition-opacity duration-500 ease-in-out opacity-0 px-2 sm:px-4 md:px-8">
                {# Content will be dynamically loaded here by JavaScript #}
            </div>

            {# Slide indicator dots - positioned at the bottom of the slideshow container #}
            {# Z-index is z-30 to ensure it's on top of the slideshow container #}
            <div id="slide-indicators" class="absolute bottom-6 flex space-x-2 z-30">
                {# Dots will be dynamically generated by JavaScript #}
            </div>

            {# Footer message for the main message slide #}
            {# Changed bottom-6 to bottom-12 to move it above the indicators #}
            <div id="main-message-footer" class="absolute bottom-12 w-full px-6 z-30 text-gray-700">
                <p class="text-sm sm:text-base" id="footer-message">Click arrows to navigate!</p>
            </div>

        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get references to key DOM elements
        const slideshowContainer = document.getElementById('slideshow-container');
        const slideContent = document.getElementById('slide-content');
        const slideIndicators = document.getElementById('slide-indicators');
        const mainMessageFooter = document.getElementById('main-message-footer');
        const footerMessageElement = document.getElementById('footer-message'); // New element for dynamic footer message
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');

        // Extract story and contributions data from Django context.
        const story = {
            title: "{{ story.title|escapejs }}",
            main_message: "{{ story.main_message|escapejs }}"
        };
        // Parse contributions JSON. Added a fallback to empty array if parsing fails or data is null.
        let contributions = [];
        try {
            const rawContributions = '{{ contributions|safe|escapejs }}';
            // Check if rawContributions is not just an empty string or '[]'
            if (rawContributions && rawContributions !== '[]') {
                contributions = JSON.parse(rawContributions);
            }
        } catch (e) {
            console.error("Error parsing contributions JSON:", e);
            console.log("Raw contributions string:", '{{ contributions|safe|escapejs }}');
        }


        // Combine the main story message and all contributions into a single array.
        // The main message is the first "slide".
        const slides = [{
            type: 'main_message',
            title: story.title,
            content: story.main_message,
            contributor_name: 'The Organiser' // Default contributor for the main message
        }].concat(contributions);

        let currentSlideIndex = 0; // Tracks the currently displayed slide

        console.log("Slides data loaded:", slides); // Log the slides data for debugging
        console.log("Story title:", story.title);
        console.log("Story main message:", story.main_message);


        /**
         * Renders the slide at the given index.
         * It handles content transitions (fade out/in) and updates UI elements.
         * @param {number} index - The index of the slide to render.
         */
        function renderSlide(index) {
            // Basic boundary check for the slide index
            if (index < 0 || index >= slides.length) {
                console.warn("Attempted to render slide out of bounds:", index);
                return;
            }

            const slide = slides[index];
            console.log("Rendering slide:", slide); // Log the slide being rendered

            // Step 1: Fade out the current content
            slideContent.style.opacity = '0';
            slideContent.style.transform = 'scale(0.95)'; // Slight scale effect for transition

            // Wait for fade-out transition, then update content and fade in
            setTimeout(() => {
                slideContent.innerHTML = ''; // Clear previous content

                let contentHtml = '';
                let contributorInfo = '';
                let captionInfo = '';

                // Add contributor information if available
                if (slide.contributor_name) {
                    contributorInfo = `<p class="text-gray-600 text-sm sm:text-base mb-2 font-medium">From: <span class="font-semibold text-indigo-700">${slide.contributor_name}</span></p>`;
                }

                // Add caption information if available
                if (slide.caption) {
                    captionInfo = `<p class="text-gray-700 text-base sm:text-lg mt-2 mb-4 font-normal">${slide.caption}</p>`;
                }

                // Determine content based on slide type
                if (slide.type === 'main_message') {
                    contentHtml = `
                        <h2 class="text-3xl sm:text-4xl md:text-5xl font-bold text-gray-900 mb-4 leading-tight">${slide.title}</h2>
                        <p class="text-lg sm:text-xl md:text-2xl text-gray-700 leading-relaxed max-h-[calc(100%-100px)] overflow-y-auto custom-scrollbar">${slide.content}</p>
                    `;
                    mainMessageFooter.style.display = 'block'; // Show footer for the main message slide
                    if (slides.length > 1) { // Only show navigation hint if there are more slides
                        footerMessageElement.textContent = 'Click arrows to navigate!';
                    } else {
                        footerMessageElement.textContent = 'No contributions yet.';
                    }
                } else if (slide.type === 'text') {
                    contentHtml = `
                        ${contributorInfo}
                        <p class="text-xl sm:text-2xl md:text-3xl text-gray-800 leading-relaxed max-h-[calc(100%-100px)] overflow-y-auto custom-scrollbar">${slide.content}</p>
                    `;
                    mainMessageFooter.style.display = 'none'; // Hide footer for contribution slides
                } else if (slide.type === 'image') {
                    contentHtml = `
                        ${contributorInfo}
                        <img src="${slide.image}" alt="${slide.caption || 'Contributed image'}" class="max-w-full max-h-[60vh] sm:max-h-[70vh] object-contain rounded-lg shadow-md mb-2">
                        ${captionInfo}
                    `;
                    mainMessageFooter.style.display = 'none';
                } else if (slide.type === 'video') {
                    let videoPlayerHtml = '';
                    if (slide.youtube_video_id) {
                        // Embed YouTube video using iframe
                        videoPlayerHtml = `
                            <div class="relative w-full" style="padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 0.5rem;">
                                <iframe class="absolute top-0 left-0 w-full h-full rounded-lg"
                                        src="https://www.youtube.com/embed/${slide.youtube_video_id}?autoplay=1&mute=1" 
                                        frameborder="0" 
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                        allowfullscreen>
                                </iframe>
                            </div>
                        `;
                    } else if (slide.video) {
                        // Embed direct video file
                        videoPlayerHtml = `
                            <video controls autoplay muted class="w-full max-h-[60vh] sm:max-h-[70vh] object-contain rounded-lg shadow-md">
                                <source src="${slide.video}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        `;
                    }
                    contentHtml = `
                        ${contributorInfo}
                        ${videoPlayerHtml}
                        ${captionInfo}
                    `;
                    mainMessageFooter.style.display = 'none';
                }

                slideContent.innerHTML = contentHtml; // Insert the new content
                
                // Step 3: Fade in the new content
                slideContent.style.opacity = '1';
                slideContent.style.transform = 'scale(1)';

                // Update indicators and navigation buttons for the new slide
                updateIndicators();
                updateNavigationButtons();
            }, 300); // The timeout duration should match the CSS transition duration for a smooth effect
        }

        /**
         * Updates the visual state of the slide indicator dots.
         */
        function updateIndicators() {
            slideIndicators.innerHTML = ''; // Clear existing dots
            if (slides.length <= 1) { // Hide indicators if only one slide
                slideIndicators.style.display = 'none';
                return;
            }
            slideIndicators.style.display = 'flex'; // Ensure visible if multiple slides

            slides.forEach((_, idx) => {
                const dot = document.createElement('span');
                // Apply Tailwind classes for styling the dots
                dot.classList.add('w-3', 'h-3', 'rounded-full', 'bg-gray-400', 'transition-all', 'duration-300', 'cursor-pointer');
                if (idx === currentSlideIndex) {
                    // Highlight the active dot
                    dot.classList.add('bg-purple-600', 'scale-125');
                }
                // Add click listener to navigate to a specific slide
                dot.addEventListener('click', () => {
                    currentSlideIndex = idx;
                    renderSlide(currentSlideIndex);
                });
                slideIndicators.appendChild(dot);
            });
        }

        /**
         * Updates the visibility of the previous and next navigation buttons.
         */
        function updateNavigationButtons() {
            // Ensure buttons exist before trying to modify them
            if (prevBtn && nextBtn) { 
                // Only show arrows if there are multiple slides to navigate
                if (slides.length <= 1) { 
                    prevBtn.style.display = 'none';
                    nextBtn.style.display = 'none';
                } else {
                    // Show/hide buttons based on current slide index
                    prevBtn.style.display = currentSlideIndex === 0 ? 'none' : 'block';
                    nextBtn.style.display = currentSlideIndex === slides.length - 1 ? 'none' : 'block';
                }
            }
        }

        /**
         * Navigates to the next slide if available.
         */
        function nextSlide() {
            if (currentSlideIndex < slides.length - 1) {
                currentSlideIndex++;
                renderSlide(currentSlideIndex);
            }
        }

        /**
         * Navigates to the previous slide if available.
         */
        function prevSlide() {
            if (currentSlideIndex > 0) {
                currentSlideIndex--;
                renderSlide(currentSlideIndex);
            }
        }

        /**
         * Stops any currently playing video or audio within the slide content.
         * This is important to prevent media from continuing to play when navigating away.
         */
        function stopMediaPlayback() {
            // Stop HTML5 video
            const currentVideo = slideContent.querySelector('video');
            if (currentVideo) {
                currentVideo.pause();
                currentVideo.currentTime = 0; // Rewind to start
            }
            // Stop YouTube iframe video by reloading its source
            const currentIframe = slideContent.querySelector('iframe');
            if (currentIframe) {
                const src = currentIframe.src;
                currentIframe.src = src; 
            }
        }

        // Click listeners for navigation buttons
        if (prevBtn) {
            prevBtn.addEventListener('click', () => {
                prevSlide();
                console.log("Previous button clicked.");
            });
        }
        if (nextBtn) {
            nextBtn.addEventListener('click', () => {
                nextSlide();
                console.log("Next button clicked.");
            });
        }

        // Custom scrollbar styling for text content (for overflow)
        const style = document.createElement('style');
        style.innerHTML = `
            .custom-scrollbar::-webkit-scrollbar {
                width: 8px;
            }
            .custom-scrollbar::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 10px;
            }
            .custom-scrollbar::-webkit-scrollbar-thumb {
                background: #888;
                border-radius: 10px;
            }
            .custom-scrollbar::-webkit-scrollbar-thumb:hover {
                background: #555;
            }
            /* Firefox scrollbar styling */
            .custom-scrollbar {
                scrollbar-width: thin;
                scrollbar-color: #888 #f1f1f1;
            }
        `;
        document.head.appendChild(style);


        // Initial render of the first slide when the page loads
        renderSlide(currentSlideIndex);
    });
</script>
{% endblock %}