{# your_app_name/templates/your_app_name/story_slideshow.html #}
{% extends 'main/base.html' %}
{% load static %}

{% block content %}
<div class="relative min-h-screen bg-gray-100 flex flex-col items-center justify-center p-4">
    <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-4xl h-[calc(100vh-120px)] flex flex-col">
        <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">
            <span class="text-indigo-600">{{ story.title }}</span> - The Story Unfolds
        </h2>

        <div id="slideshow-content" class="flex-grow flex items-center justify-center text-center overflow-hidden relative">
            {# Content will be injected here by JavaScript #}
        </div>

        <div class="flex justify-between items-center mt-6">
            <button id="prev-slide" class="px-6 py-3 bg-indigo-500 text-white rounded-lg shadow-md hover:bg-indigo-600 transition duration-150 ease-in-out">
                Previous
            </button>
            <span id="slide-counter" class="text-lg font-semibold text-gray-700">0/0</span>
            <button id="next-slide" class="px-6 py-3 bg-indigo-500 text-white rounded-lg shadow-md hover:bg-indigo-600 transition duration-150 ease-in-out">
                Next
            </button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const contributions = JSON.parse('{{ contributions|escapejs }}');
        let currentSlide = 0;
        const slideshowContainer = document.getElementById('slideshow-content');
        const slideCounter = document.getElementById('slide-counter');
        const totalSlides = contributions.length;

        function showSlide(index) {
            if (totalSlides === 0) {
                slideshowContainer.innerHTML = '<p class="text-center text-gray-600 text-xl">No approved contributions to display yet.</p>';
                slideCounter.textContent = '0/0';
                return;
            }

            currentSlide = (index + totalSlides) % totalSlides;
            const contribution = contributions[currentSlide];

            let contentHtml = '';
            let mediaElement = '';

            if (contribution.type === 'text') {
                contentHtml = `<p class="text-xl md:text-2xl lg:text-3xl font-serif text-gray-800 leading-relaxed">${contribution.content}</p>`;
            } else if (contribution.type === 'image') {
                // Use 'image_url' which now contains the pre-signed URL
                if (contribution.image_url) { 
                    mediaElement = `<img src="${contribution.image_url}" alt="${contribution.caption || 'Image'}" class="max-h-full max-w-full object-contain mx-auto rounded-lg shadow-md">`;
                } else {
                    mediaElement = `<div class="w-full h-full bg-gray-200 flex items-center justify-center text-gray-500 rounded-lg">Image Not Available</div>`;
                }
                contentHtml = `<p class="text-lg text-gray-700 mt-4">${contribution.caption || ''}</p>`;
            } else if (contribution.type === 'video') {
                // Use 'video_url' which now contains the pre-signed URL
                if (contribution.youtube_video_id) {
                    mediaElement = `
                        <div class="relative w-full" style="padding-bottom: 56.25%;">
                            <iframe class="absolute top-0 left-0 w-full h-full rounded-lg shadow-md" 
                                src="https://www.youtube.com/embed/${contribution.youtube_video_id}" 
                                frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
                            </iframe>
                        </div>`;
                } else if (contribution.video_url) { 
                    mediaElement = `
                        <video controls class="max-h-full max-w-full object-contain mx-auto rounded-lg shadow-md">
                            <source src="${contribution.video_url}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>`;
                } else {
                    mediaElement = `<div class="w-full h-full bg-gray-200 flex items-center justify-center text-gray-500 rounded-lg">Video Not Available</div>`;
                }
                contentHtml = `<p class="text-lg text-gray-700 mt-4">${contribution.caption || ''}</p>`;
            }

            slideshowContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full w-full p-4">
                    <div class="flex-grow flex items-center justify-center w-full">
                        ${mediaElement ? mediaElement : contentHtml}
                    </div>
                    ${mediaElement ? contentHtml : ''} {# Only show caption if there's media #}
                    <p class="text-sm text-gray-500 mt-4">
                        - ${contribution.contributor_name} on ${new Date(contribution.created_at).toLocaleDateString()}
                    </p>
                </div>
            `;
            slideCounter.textContent = `${currentSlide + 1}/${totalSlides}`;
        }

        function nextSlide() {
            showSlide(currentSlide + 1);
        }

        function prevSlide() {
            showSlide(currentSlide - 1);
        }

        document.getElementById('prev-slide').addEventListener('click', prevSlide);
        document.getElementById('next-slide').addEventListener('click', nextSlide);

        // Initial display
        showSlide(currentSlide);
    });
</script>
{% endblock content %}
