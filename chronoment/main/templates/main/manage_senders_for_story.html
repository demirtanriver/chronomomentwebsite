{# your_app_name/templates/your_app_name/manage_senders_for_story.html #}
{% extends 'main/base.html' %}
{% load static %}

{% block content %}
<div class="p-4 w-full max-w-3xl mx-auto"> {# Increased max-width for better layout of existing senders #}
    <div class="bg-white p-8 rounded-xl shadow-lg">
        <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">
            Manage Senders for <span class="text-indigo-600">'{{ story.title }}'</span>
        </h2>
        <p class="text-center text-gray-600 mb-6">
            You have invited {{ existing_story_senders.count }} out of {{ story.max_senders }} allowed senders.
        </p>

        {# Section for Adding New Senders #}
        <div class="mb-10 p-6 border border-gray-200 rounded-lg shadow-sm">
            <h3 class="text-2xl font-semibold text-gray-800 mb-6">Add New Senders</h3>
            <form method="post" class="space-y-6" novalidate>
                {% csrf_token %}
                <input type="hidden" name="action" value="add_new_senders"> {# Hidden input to identify action #}
                
                {{ formset.management_form }}

                {# Added data-attributes for JavaScript to read values reliably #}
                <div id="formset-container" 
                     class="space-y-4"
                     data-max-senders="{{ story.max_senders|default:0 }}"
                     data-initial-existing-senders="{{ existing_story_senders.count|default:0 }}">
                    {# Loop through forms provided by Django (e.g., if there were validation errors) #}
                    {% for form in formset %}
                        <div class="sender-form border border-gray-100 p-4 rounded-lg bg-gray-50 {% if form.errors %}border-red-200 bg-red-50{% endif %}" data-form-id="{{ forloop.counter0 }}">
                            <h5 class="text-lg font-medium text-gray-700 mb-3">Sender #{{ forloop.counter }} {% if form.errors %}<span class="text-red-700">(Errors Below)</span>{% endif %}</h5>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="{{ form.email.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Sender Email</label>
                                    {{ form.email }} {# Render the email field using Django's form rendering #}
                                    {% if form.email.errors %}<p class="mt-1 text-sm text-red-600">{{ form.email.errors }}</p>{% endif %}
                                    <p class="mt-2 text-sm text-gray-500">Required. The email address of the person you want to invite.</p>
                                </div>
                                <div>
                                    <label for="{{ form.name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Sender Name</label>
                                    {{ form.name }} {# Render the name field using Django's form rendering #}
                                    {% if form.name.errors %}<p class="mt-1 text-sm text-red-600">{{ form.name.errors }}</p>{% endif %}
                                    <p class="mt-2 text-sm text-gray-500">Required. A name to identify this sender.</p>
                                </div>
                            </div>
                            <button type="button" class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out remove-form-button">Remove Sender</button>
                        </div>
                    {% endfor %}
                </div>

                <div class="mt-6">
                    {# Dynamically adjust button text and visibility #}
                    {% if remaining_slots > 0 %}
                        <button type="button" id="add-more-senders" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-base font-semibold text-white bg-indigo-500 hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                            Add Another Sender (<span id="remaining-slots-text">{{ remaining_slots }}</span> slot{{ remaining_slots|pluralize }} left)
                        </button>
                    {% else %}
                        <p class="text-center text-gray-600 text-lg">You have reached the maximum number of senders ({{ story.max_senders }}) for this story.</p>
                    {% endif %}
                </div>

                {% if remaining_slots > 0 %}
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-base font-semibold text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out mt-4">Invite New Senders</button>
                {% else %}
                    <button type="submit" disabled class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-base font-semibold text-white bg-gray-400 cursor-not-allowed mt-4">Invite New Senders</button>
                {% endif %}
            </form>
        </div>

        {# Section for Existing Senders #}
        {% if existing_story_senders %}
            <div class="mt-10 p-6 border border-gray-200 rounded-lg shadow-sm">
                <h3 class="text-2xl font-semibold text-gray-800 mb-6">Existing Senders</h3>
                <ul class="space-y-4">
                    {% for ss in existing_story_senders %}
                        {# Dynamic background class based on invitation_status #}
                        <li class="p-4 rounded-lg shadow-sm flex flex-col md:flex-row md:items-center justify-between space-y-3 md:space-y-0 md:space-x-4
                            {% if ss.invitation_status == 'pending' %}bg-yellow-50 border-yellow-200{% endif %}
                            {% if ss.invitation_status == 'contributed' %}bg-blue-50 border-blue-200{% endif %}
                            {% if ss.invitation_status == 'accepted' %}bg-green-50 border-green-200{% endif %}
                            {% if ss.invitation_status == 'expired' %}bg-red-50 border-red-200{% endif %}
                        ">
                            <div class="flex-grow">
                                <p class="text-lg font-medium text-gray-800">{{ ss.sender.name|default:ss.sender.email }}</p>
                                <p class="text-gray-600 text-sm">{{ ss.sender.email }}</p>
                                <p class="text-gray-500 text-xs mt-1">
                                    Status: 
                                    {% if ss.invitation_status == 'pending' %}
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Pending</span>
                                    {% elif ss.invitation_status == 'contributed' %}
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">Contributed</span>
                                    {% elif ss.invitation_status == 'accepted' %}
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Accepted</span>
                                    {% elif ss.invitation_status == 'expired' %}
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Expired</span>
                                    {% endif %}
                                    {% if ss.token_expires_at %}
                                        | Expires: {{ ss.token_expires_at|date:"M j, Y H:i" }}
                                    {% endif %}
                                </p>
                            </div>
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                                {# View Contributions Button #}
                                <a href="{% url 'view_sender_contributions' story.id ss.id %}"
                                   class="w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-150 ease-in-out">
                                    View Contributions
                                </a>
                                {# Resend Invite Button #}
                                <form method="post" action="{% url 'manage_senders_for_story' story.id %}" class="inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="resend_invite">
                                    <input type="hidden" name="story_sender_id" value="{{ ss.id }}">
                                    <button type="submit"
                                            class="w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                                        Resend Invite
                                    </button>
                                </form>
                                {# Delete Sender Button - Adjusted form class for consistent height #}
                                <form method="post" action="{% url 'manage_senders_for_story' story.id %}" class="w-full sm:w-auto inline-flex" onsubmit="return confirm('Are you sure you want to remove {{ ss.sender.email }} from this story?');">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="delete_sender">
                                    <input type="hidden" name="story_sender_id" value="{{ ss.id }}">
                                    <button type="submit"
                                            class="w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out">
                                        Remove
                                    </button>
                                </form>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        {% else %}
            <div class="text-center py-8">
                <p class="text-gray-600 text-lg mb-4">No senders have been invited to this story yet.</p>
            </div>
        {% endif %}

        <div class="text-center mt-8 pt-6 border-t border-gray-200">
            <a href="{% url 'story_detail' story.id %}" class="font-medium text-indigo-600 hover:text-indigo-500 mr-4">Back to Story Details</a>
            <a href="{% url 'my_stories' %}" class="font-medium text-gray-600 hover:text-gray-800">Back to My Stories</a> {# Changed to My Stories #}
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM Content Loaded for manage_senders_for_story.html");

        const formsetContainer = document.getElementById('formset-container');
        const addMoreButton = document.getElementById('add-more-senders');
        const totalFormsInput = document.querySelector('#id_senders-TOTAL_FORMS');
        const maxFormsInput = document.querySelector('#id_senders-MAX_NUM_FORMS');
        const remainingSlotsText = document.getElementById('remaining-slots-text'); // Get the span for live updates

        // Store the initial existing senders count and story max senders from data attributes
        const initialExistingSendersCount = parseInt(formsetContainer.dataset.initialExistingSenders);
        const storyMaxSenders = parseInt(formsetContainer.dataset.maxSenders);

        console.log("formsetContainer element:", formsetContainer);
        console.log("addMoreButton element:", addMoreButton);
        console.log("totalFormsInput element:", totalFormsInput);
        console.log("maxFormsInput element:", maxFormsInput);
        console.log("remainingSlotsText element:", remainingSlotsText);
        console.log("initialExistingSendersCount:", initialExistingSendersCount);
        console.log("storyMaxSenders:", storyMaxSenders);

        // Check if essential elements are found before proceeding
        if (!totalFormsInput || !maxFormsInput || !formsetContainer) {
            console.error("One or more formset management elements not found. Dynamic formset will not function.");
            return;
        }

        let formIdx = parseInt(totalFormsInput.value);

        // The template for new forms, defined directly in JavaScript for robustness.
        // IMPORTANT: The `name` and `id` attributes must use `__prefix__` for Django formsets.
        const emptyFormTemplateHtml = `
            <div class="sender-form border border-gray-100 p-4 rounded-lg bg-gray-50">
                <h5 class="text-lg font-medium text-gray-700 mb-3">Sender #__prefix_display__</h5>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="id_senders-__prefix__-email" class="block text-sm font-medium text-gray-700 mb-1">Sender Email</label>
                        <input type="email" 
                                name="senders-__prefix__-email" 
                                id="id_senders-__prefix__-email" 
                                value="" 
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" 
                                placeholder="sender@example.com" 
                                required>
                        <p class="mt-2 text-sm text-gray-500">Required. The email address of the person you want to invite.</p>
                    </div>
                    <div>
                        <label for="id_senders-__prefix__-name" class="block text-sm font-medium text-gray-700 mb-1">Sender Name</label>
                        <input type="text" 
                                name="senders-__prefix__-name" 
                                id="id_senders-__prefix__-name" 
                                value="" 
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" 
                                placeholder="e.g., Jane Doe" 
                                required>
                        <p class="mt-2 text-sm text-gray-500">Required. A name to identify this sender.</p>
                    </div>
                </div>
                <button type="button" class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out remove-form-button">Remove Sender</button>
            </div>
        `;

        function updateAddButtonState() {
            const currentFormsInDom = formsetContainer.querySelectorAll('.sender-form').length;
            const totalSendersIncludingNew = initialExistingSendersCount + currentFormsInDom;
            const slotsLeft = storyMaxSenders - totalSendersIncludingNew;
            
            if (remainingSlotsText) {
                remainingSlotsText.textContent = Math.max(0, slotsLeft);
            }

            if (addMoreButton) {
                if (slotsLeft <= 0) {
                    addMoreButton.style.display = 'none'; // Hide button if no slots left
                } else {
                    addMoreButton.style.display = 'block'; // Show button if slots available
                    addMoreButton.textContent = `Add Another Sender (${slotsLeft} slot${slotsLeft !== 1 ? 's' : ''} left)`;
                }
            }

            // Update submit button state: enable if there's at least one new form, or if there were errors
            const submitButton = document.querySelector('button[type="submit"]');
            if (submitButton) {
                const hasNewForms = currentFormsInDom > 0;
                const hasErrors = formsetContainer.querySelector('.sender-form.border-red-200');

                if (hasNewForms || hasErrors || initialExistingSendersCount > 0) { 
                    submitButton.disabled = false;
                    submitButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    submitButton.classList.add('bg-green-600', 'hover:bg-green-700');
                } else {
                    submitButton.disabled = true;
                    submitButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                    submitButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                }
            }
        }

        // Function to update form indices and display numbers after add/remove
        function updateFormIndices() {
            const forms = formsetContainer.querySelectorAll('.sender-form');
            forms.forEach((formElement, index) => {
                const oldFormId = formElement.dataset.formId; // Get the original data-form-id
                const newFormId = index; // The new sequential index within the DOM

                formElement.dataset.formId = newFormId; // Update data-form-id

                // Update input names and IDs
                formElement.querySelectorAll('[name]').forEach(input => {
                    if (input.name && input.name.includes(`senders-${oldFormId}`)) {
                        input.name = input.name.replace(`senders-${oldFormId}`, `senders-${newFormId}`);
                    }
                });
                formElement.querySelectorAll('[id]').forEach(input => {
                    if (input.id && input.id.includes(`id_senders-${oldFormId}`)) {
                        input.id = input.id.replace(`id_senders-${oldFormId}`, `id_senders-${newFormId}`);
                    }
                });

                // Update label's for attribute
                formElement.querySelectorAll('label').forEach(label => {
                    const forAttr = label.getAttribute('for');
                    if (forAttr && forAttr.includes(`id_senders-${oldFormId}`)) {
                        label.setAttribute('for', forAttr.replace(`id_senders-${oldFormId}`, `id_senders-${newFormId}`));
                    }
                });

                // Update heading number for display
                const heading = formElement.querySelector('h5');
                if (heading) {
                    heading.textContent = `Sender #${initialExistingSendersCount + newFormId + 1}`;
                }

                // Show/hide remove button based on if it's the only form
                const removeButton = formElement.querySelector('.remove-form-button');
                if (removeButton) {
                    // If there's only one form left (and no existing senders in DB), hide its remove button
                    if (formsetContainer.querySelectorAll('.sender-form').length === 1 && initialExistingSendersCount === 0) {
                        removeButton.style.display = 'none';
                    } else {
                        removeButton.style.display = 'block';
                    }
                }
            });
            console.log("Forms re-indexed.");
        }

        // Add new form click handler
        if (addMoreButton) { 
            addMoreButton.addEventListener('click', function() {
                console.log("Add More Senders button clicked.");
                const currentFormsInDom = formsetContainer.querySelectorAll('.sender-form').length;
                const totalSendersIncludingNew = initialExistingSendersCount + currentFormsInDom;

                if (totalSendersIncludingNew < storyMaxSenders) {
                    const newFormInstanceHtml = emptyFormTemplateHtml
                        .replace(/__prefix__/g, formIdx) // Use formIdx for Django's internal prefix
                        .replace(/__prefix_display__/g, initialExistingSendersCount + currentFormsInDom + 1); // For display number
                    
                    const newFormDiv = document.createElement('div');
                    newFormDiv.innerHTML = newFormInstanceHtml.trim();
                    formsetContainer.appendChild(newFormDiv.firstElementChild); // Append the actual div
                    
                    formIdx++; // Increment formIdx for the next new form
                    totalFormsInput.value = formIdx; // Update the hidden TOTAL_FORMS input

                    updateFormIndices(); // Re-index all forms for correct display and Django processing
                    updateAddButtonState(); // Update slots and button state
                } else {
                    alert('Maximum number of senders reached.'); // Consider a custom modal for better UX
                }
            });
        }

        // Handle removing forms using event delegation
        formsetContainer.addEventListener('click', function(event) {
            if (event.target.classList.contains('remove-form-button')) {
                console.log("Remove Sender button clicked.");
                const formToRemove = event.target.closest('.sender-form');
                if (formToRemove) {
                    formToRemove.remove(); // Remove the form from the DOM
                    formIdx--; // Decrement formIdx
                    totalFormsInput.value = formIdx; // Update the hidden TOTAL_FORMS input

                    updateFormIndices(); // Re-index remaining forms
                    updateAddButtonState(); // Update slots and button state
                }
            }
        });

        // Initial form rendering logic on page load
        const formsCurrentlyInDom = formsetContainer.querySelectorAll('.sender-form').length;
        if (formsCurrentlyInDom === 0 && (storyMaxSenders - initialExistingSendersCount) > 0) {
            if (addMoreButton) { // Ensure button exists before simulating click
                addMoreButton.click();
            }
        } else {
            updateFormIndices();
            updateAddButtonState();
        }
    });
</script>
{% endblock content %}
