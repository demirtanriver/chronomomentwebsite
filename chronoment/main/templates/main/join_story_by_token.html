{# your_app_name/templates/your_app_name/join_story_by_token.html #}
{% extends 'main/base.html' %}
{% load static %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="bg-white p-8 rounded-xl shadow-lg max-w-4xl mx-auto">
        {% if expired %}
            <h2 class="text-3xl font-bold text-center text-red-600 mb-6">Invitation Expired</h2>
            <p class="text-center text-gray-700 mb-4">
                Unfortunately, the invitation link for '{{ story.title }}' has expired.
            </p>
            <p class="text-center text-gray-700 mb-6">
                Please contact the story organiser ({{ story.organiser.first_name }} {{ story.organiser.last_name }}) to request a new invitation.
            </p>
            <div class="text-center mt-6">
                <a href="{% url 'home' %}" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Go to Home
                </a>
            </div>
        {% else %}
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">
                Contribute to <span class="text-indigo-600">'{{ story.title }}'</span>
            </h2>
            <p class="text-center text-gray-600 mb-6">
                Welcome, <span class="font-semibold">{{ sender.name|default:sender.email }}</span>! Share your memories for this story.
            </p>

            {# Contribution Forms Section #}
            <div class="mb-10 p-6 border border-gray-200 rounded-lg shadow-sm">
                <h3 class="text-2xl font-semibold text-gray-800 mb-6">Add Your Contribution</h3>
                
                {# Tabs for contribution types #}
                <div class="flex border-b border-gray-200 mb-6">
                    <button class="tab-button flex-1 py-3 text-center text-lg font-medium text-gray-600 hover:text-indigo-600 border-b-2 border-transparent hover:border-indigo-500 transition duration-150 ease-in-out active-tab" data-tab="text-tab">Text</button>
                    <button class="tab-button flex-1 py-3 text-center text-lg font-medium text-gray-600 hover:text-indigo-600 border-b-2 border-transparent hover:border-indigo-500 transition duration-150 ease-in-out" data-tab="image-tab">Image</button>
                    <button class="tab-button flex-1 py-3 text-center text-lg font-medium text-gray-600 hover:text-indigo-600 border-b-2 border-transparent hover:border-indigo-500 transition duration-150 ease-in-out" data-tab="video-tab">Video</button>
                </div>

                {# Text Contribution Form #}
                <div id="text-tab" class="tab-content active">
                    <form method="post" enctype="multipart/form-data" class="space-y-4">
                        {% csrf_token %}
                        <input type="hidden" name="contribution_type" value="text">
                        <div>
                            <label for="{{ text_form.content.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Your Message</label>
                            {{ text_form.content }}
                            {% if text_form.content.errors %}<p class="mt-1 text-sm text-red-600">{{ text_form.content.errors }}</p>{% endif %}
                            <p class="mt-2 text-sm text-gray-500">Share your thoughts or memories.</p>
                        </div>
                        <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Add Message
                        </button>
                    </form>
                </div>

                {# Image Contribution Form #}
                <div id="image-tab" class="tab-content hidden">
                    <form method="post" enctype="multipart/form-data" class="space-y-4">
                        {% csrf_token %}
                        <input type="hidden" name="contribution_type" value="image">
                        <div>
                            <label for="{{ image_form.image.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Upload Image</label>
                            {{ image_form.image }}
                            {% if image_form.image.errors %}<p class="mt-1 text-sm text-red-600">{{ image_form.image.errors }}</p>{% endif %}
                            <p class="mt-2 text-sm text-gray-500">Supported formats: JPG, PNG. Max size: 5MB.</p>
                        </div>
                        <div>
                            <label for="{{ image_form.caption.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Caption (Optional)</label>
                            {{ image_form.caption }}
                            {% if image_form.caption.errors %}<p class="mt-1 text-sm text-red-600">{{ image_form.caption.errors }}</p>{% endif %}
                            <p class="mt-2 text-sm text-gray-500">Describe your image.</p>
                        </div>
                        <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Add Image
                        </button>
                    </form>
                </div>

                {# Video Contribution Form #}
                <div id="video-tab" class="tab-content hidden">
                    <form method="post" enctype="multipart/form-data" class="space-y-4">
                        {% csrf_token %}
                        <input type="hidden" name="contribution_type" value="video">
                        <p class="text-sm text-gray-600 mb-4">You can either upload a video file or provide a YouTube video URL.</p>
                        
                        <div>
                            <label for="{{ video_form.video.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Upload Video File</label>
                            {{ video_form.video }}
                            {% if video_form.video.errors %}<p class="mt-1 text-sm text-red-600">{{ video_form.video.errors }}</p>{% endif %}
                            <p class="mt-2 text-sm text-gray-500">Supported formats: MP4. Max size: 20MB.</p>
                        </div>
                        <div class="text-center text-gray-500 my-4">OR</div>
                        <div>
                            <label for="{{ video_form.youtube_url.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">YouTube Video URL</label> {# <-- CHANGED LABEL #}
                            {{ video_form.youtube_url }} {# <-- CHANGED FIELD NAME #}
                            {% if video_form.youtube_url.errors %}<p class="mt-1 text-sm text-red-600">{{ video_form.youtube_url.errors }}</p>{% endif %} {# <-- CHANGED FIELD NAME #}
                            <p class="mt-2 text-sm text-gray-500">e.g., `https://www.youtube.com/watch?v=dQw4w9WgXcQ`</p> {# <-- CHANGED EXAMPLE #}
                        </div>
                        <div>
                            <label for="{{ video_form.caption.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Caption (Optional)</label>
                            {{ video_form.caption }}
                            {% if video_form.caption.errors %}<p class="mt-1 text-sm text-red-600">{{ video_form.caption.errors }}</p>{% endif %}
                            <p class="mt-2 text-sm text-gray-500">Describe your video.</p>
                        </div>
                        <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Add Video
                        </button>
                    </form>
                </div>
            </div>

            {# Existing Contributions Section #}
            <div class="mt-10 p-6 border border-gray-200 rounded-lg shadow-sm">
                <h3 class="text-2xl font-semibold text-gray-800 mb-6">Your Existing Contributions</h3>
                
                {% if existing_text_contributions or existing_image_contributions or existing_video_contributions %}
                    <ul class="space-y-6">
                        {% for text_c in existing_text_contributions %}
                            <li class="bg-gray-50 p-4 rounded-lg shadow-sm">
                                <p class="text-gray-800 text-lg mb-2">{{ text_c.content }}</p>
                                <p class="text-xs text-gray-500">Contributed: {{ text_c.created_at|date:"M j, Y H:i" }}</p>
                                <p class="text-xs text-gray-500">Status: <span class="font-semibold text-blue-600">{{ text_c.get_status_display }}</span></p>
                            </li>
                        {% endfor %}

                        {% for img_c in existing_image_contributions %}
                            <li class="bg-gray-50 p-4 rounded-lg shadow-sm">
                                {% if img_c.presigned_url %} {# Use presigned_url here #}
                                    <img src="{{ img_c.presigned_url }}" alt="{{ img_c.caption|default:'Image contribution' }}" class="w-full h-48 object-cover rounded-md mb-2">
                                {% else %}
                                    <div class="w-full h-48 bg-gray-200 flex items-center justify-center rounded-md mb-2 text-gray-500">No Image Preview</div>
                                {% endif %}
                                <p class="text-gray-800 text-lg">{{ img_c.caption }}</p>
                                <p class="text-xs text-gray-500 mt-1">Contributed: {{ img_c.created_at|date:"M j, Y H:i" }}</p>
                                <p class="text-xs text-gray-500">Status: <span class="font-semibold text-blue-600">{{ img_c.get_status_display }}</span></p>
                            </li>
                        {% endfor %}

                        {% for vid_c in existing_video_contributions %}
                            <li class="bg-gray-50 p-4 rounded-lg shadow-sm">
                                {% if vid_c.youtube_video_id %}
                                    <div class="relative" style="padding-bottom: 56.25%;">
                                        <iframe class="absolute top-0 left-0 w-full h-full rounded-md" src="https://www.youtube.com/embed/{{ vid_c.youtube_video_id }}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                    </div>
                                {% elif vid_c.presigned_url %} {# Use presigned_url here #}
                                    <video controls class="w-full h-48 object-cover rounded-md mb-2">
                                        <source src="{{ vid_c.presigned_url }}" type="video/mp4"> {# Assuming MP4 #}
                                        Your browser does not support the video tag.
                                    </video>
                                {% else %}
                                    <div class="w-full h-48 bg-gray-200 flex items-center justify-center rounded-md mb-2 text-gray-500">No Video Preview</div>
                                {% endif %}
                                <p class="text-gray-800 text-lg">{{ vid_c.caption }}</p>
                                <p class="text-xs text-gray-500 mt-1">Contributed: {{ vid_c.created_at|date:"M j, Y H:i" }}</p>
                                <p class="text-xs text-gray-500">Status: <span class="font-semibold text-blue-600">{{ vid_c.get_status_display }}</span></p>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-center text-gray-600 text-lg">You haven't added any contributions yet.</p>
                {% endif %}
            </div>
        {% endif %} {# End if not expired #}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Remove active classes
                tabButtons.forEach(btn => btn.classList.remove('active-tab', 'border-indigo-500', 'text-indigo-600'));
                tabContents.forEach(content => content.classList.add('hidden'));

                // Add active classes to clicked button
                button.classList.add('active-tab', 'border-indigo-500', 'text-indigo-600');
                
                // Show corresponding content
                const targetTab = document.getElementById(button.dataset.tab);
                if (targetTab) {
                    targetTab.classList.remove('hidden');
                }
            });
        });

        // Set initial active tab
        const initialActiveButton = document.querySelector('.tab-button.active-tab');
        if (initialActiveButton) {
            initialActiveButton.click(); // Simulate click to set initial state
        } else if (tabButtons.length > 0) {
            tabButtons[0].click(); // Fallback to first tab if no active-tab class is set
        }
    });
</script>
{% endblock content %}
